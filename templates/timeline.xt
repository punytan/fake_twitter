<!DOCTYPE html>
<html>
<head>
<title>FakeTwitter</title>
<meta charset="UTF-8" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<style>
    * {
        margin: 0px;
        padding: 0px;}
    a {
        color: #2276BB;
        text-decoration: none;}
    input {
        border: solid 1px #85b1de;
        background-image: url('http://linknode.net/images/blue_bg.png');
        background-repeat: repeat-x;
        background-position: top;
        font-size: 13px;
        font-weight: bold;
        padding: 3px;}
    div.tabs {
        width: 900px;
        margin-right: auto;
        margin-left: auto;
        border: 1px solid gray;
        text-align: center;
        padding-bottom: 5px;
        padding-top: 5px;}
    ul#main {
        width: 900px;
        border: 1px solid gray;
        border-top: 0px;
        border-bottom: 0px;
        margin-right: auto;
        margin-left: auto;}
    li.filter {
        display : inline-block;
        border : 1px solid #ccc;
        vertical-aling : middle;
        text-align : center;
        margin : 3px;
        padding : 3px;}
    li.unread {
        background-color : #efefef;}
    li.tweet {
        border-bottom : 1px dotted #ccc;
        vertical-aling : middle;
        padding : 5px;
        list-style-type : none;}
    div.via, div.count {
        font-size : 11px;
        color : #999;
        text-align : right;}
    span.url {
        color : #2276BB; text-decoration : none;}
    div.icon {
        float : left;
        margin : 5px;
        text-align : center;
        width : 80px;}
    div#foot {
        width: 900px;
        text-align: center;
        margin-right: auto;
        margin-left: auto;
        margin-top: 3%;
        margin-bottom: 3%;}
</style>
<script>
$(function() {
   setInterval(function () {load_unread_count();}, 30000);
});
function load_unread_count () {
    $.getJSON('/api/unread/count', function(json) {
        $('.filter').remove();
        for (var tab in json) {
            var name = tab;
            var num = json[tab];
            if (name == 'success') continue;
            if (name == '') continue;
            $('div.tabs > ul').append(
                $('<li>').append(
                    $('<a>').append(name).attr({ href : "/timeline?filter=" + name }),
                    $('<b>').append(' (' + num + ') ')
                ).addClass("filter " + name)
            );
            if (num > 0) {
                $('li.' + name).addClass("unread");
            }
        }
    });
}
</script>
</head>
<body>
<div class="tabs" style="border-bottom:0px;margin-top:2%;">
    <ul>
    : for $unread_count.kv() -> $pair {
    :   if ($pair.key == 'success') {
    :   } elsif ($pair.key == '') {
    :   } else {
    <li class="filter <: if ($pair.value > 0) { "unread" } :>">
        <a href="/timeline?filter=<: $pair.key :>"><: $pair.key :></a><b> (<: $pair.value :>) </b>
    </li>
    :   }
    : }
    </ul>
</div>
<ul id="main">
<li class="tweet"></li>
: if $json.success == 1 {
:   for $json[$json.filter].kv() -> $pair {
:       my $item = $json[$json.filter][$pair.key]
<li class="tweet" id="<: $item.id :>">
    <div class="icon">
        <img src="<: $item.user.profile_image_url :>" style="height:48px; width:48px;" class="icon" />
        <div class="count" style="text-align:center;">(<: $item.user.friends_count :> / <: $item.user.followers_count :>)</div>
    </div>
    <div>
        <a href="http://twitter.com/<: $item.user.screen_name :>" target="_blank"><: $item.user.screen_name :></a>
        <: $item.processed | raw :> 
    </div>
    <div class="via" style="clear:both;">
        <a href="http://twitter.com/?status= RT @<: $item.user.screen_name :>%3A <: $item.text :>" target="_blank">RT(Unofficial)</a> / 
        <a href="http://twitter.com/?status=@<: $item.user.screen_name :> &in_reply_to_status_id=<: $item.id :>&in_reply_to=<: $item.user.screen_name :>" target="_blank">Replay</a> /
        <a href="http://twitter.com/<: $item.user.screen_name :>/status/<: $item.id :>" target="_blank"><: $item.created_at :></a>
        via 
        <: $item.source | raw :>
    </div>
</li>
:       if ($item.in_reply_to_status_id) {
<li class="reply_to tweet" id="<: $item.in_reply_to_screen_name :>-<: $item.in_reply_to_status_id :>" style="padding-left:5%;">
    <div class="icon">
        <img style="width:48px;height:48px;" />
    </div>
    <div class="text"></div>
    <div class="via" style="clear:both;"></div>
</li>
:       }
:   }
: } else {
<li class="tweet">Something is wrong with getting json.</li>
: }
: if $json.size() < 3 {
<li class="tweet"> There is no item to render.</li>
: }
</ul>
<div class="tabs" style="border-top:0px;bottom-margin:5%">
    <ul>
    : for $unread_count.kv() -> $pair {
    :   if ($pair.key == 'success') {
    :   } elsif ($pair.key == '') {
    :   } else {
    <li class="filter <: if ($pair.value > 0) { "unread" } :>">
        <a href="/timeline?filter=<: $pair.key :>"><: $pair.key :></a><b> (<: $pair.value :>) </b>
    </li>
    :   }
    : }
    </ul>
</div>
<div id="foot">
    <form action="/api/filter/new" method="POST">
        filter: <input name="filter" type="text" />
        screen_name: <input name="screen_name" type="text" />
        <input type="submit" value="submit" />
    </form>
    <form action="http://twitter.com/home">
        <input type="text" name="status" />
        <input type="submit" value="つぶやく" />
    </form>
</div>
<script>
    $('.reply_to').append(function () {
        var id = this.id;
        var dat = this.id.split('-');
        $.getJSON("/api/status", { screen_name : dat[0], id : dat[1] }, function (json) {
            $('li#' + id + ' > div.icon > img').attr({src : json.icon});
            $('li#' + id + ' > div.text').append(json.text);// + json.screen_name );
            //console.log(id, dat, json, this);
        });
    });
</script>
</body>
</html>
